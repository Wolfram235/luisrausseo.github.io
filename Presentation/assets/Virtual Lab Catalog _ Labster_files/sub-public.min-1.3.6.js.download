/*! WP Simple Pay Pro 2 - Subscriptions Add-on - 1.3.6
 * https://wpsimplepay.com/
 * Copyright (c) Moonstone Media 2017
 * Licensed GPLv2+ */

spApp.Subscriptions={},function(a){"use strict";var b=a(document.body);spApp.Subscriptions={init:function(){spApp.debugLog("spApp.Subscriptions.init",this),spApp.spFormElList.each(function(){var b=a(this);spApp.Subscriptions.processForm(b)})},processForm:function(a){var b=a.data("sc-id"),c=spApp.spFormData[b];c.subBaseRecurringAmount=c.baseAmount,c.subDiscountedRecurringAmount=c.subBaseRecurringAmount,c.subRecurringAmount=c.subBaseRecurringAmount,c.subPlanId="",c.subInterval="month",c.subIntervalCount=1,c.subSetupFee=0,c.subDefaultSetupFee=0,c.subTrialDays=0,c.subDefaultCurrency=c.currency,c.checkoutButtonLabel?c.zeroAmountCheckoutButtonLabel=c.checkoutButtonLabel:c.zeroAmountCheckoutButtonLabel=simplePaySubscriptionsFrontendGlobals.trialCheckoutButtonLabel,this.setValuesFromBaseForm(a,c),this.updateRecurringAmount(a,c),a.find(".sc-uea-custom-amount").on("keyup.spUserEnteredAmount change.spUserEnteredAmount",function(b){c.subBaseRecurringAmount=c.baseAmount,spApp.Subscriptions.updateRecurringAmount(a,c)}),a.find(".sc-cf-amount").on("change.spSelectAmount",function(b){c.subBaseRecurringAmount=c.baseAmount,""===c.couponCode.trim()&&spApp.Subscriptions.updateRecurringAmount(a,c)}),a.find(".sc_sub_wrapper").find(".sp-sub-plan").on("change.spSubPlan",function(b){spApp.Subscriptions.setValuesFromSelectedPlan(a,c),""===c.couponCode.trim()&&spApp.Subscriptions.updateRecurringAmount(a,c)}),a.on("spCouponApplyStart",function(a){}),a.on("spCouponApplied",function(b){c.subDiscountedRecurringAmount=c.discountedAmount,spApp.Subscriptions.updateRecurringAmount(a,c)}),a.on("spCouponRemoved",function(b){c.subDiscountedRecurringAmount=c.discountedAmount,spApp.Subscriptions.updateRecurringAmount(a,c)}),a.on("spQuantityChanged",function(b){a.find(".sc_sub_quantity").length>0&&a.find(".sc_sub_quantity").val(c.itemQuantity),spApp.Subscriptions.updateRecurringAmount(a,c)});var d=this.getSelectedPlan(a);d.trigger("change.spSubPlan"),a.trigger("spQuantityChanged")},setValuesFromBaseForm:function(a,b){a.find(".sc_sub_amount").length>0&&(b.subBaseRecurringAmount=parseInt(a.find(".sc_sub_amount").val())),a.find(".sc_sub_id").length>0&&(b.subPlanId=a.find(".sc_sub_id").val()),a.find(".sc_sub_interval").length>0&&(b.subInterval=a.find(".sc_sub_interval").val()),a.find(".sc_sub_interval_count").length>0&&(b.subIntervalCount=parseInt(a.find(".sc_sub_interval_count").val())),a.find(".sc_sub_setup_fee").length>0&&(b.subSetupFee=parseInt(a.find(".sc_sub_setup_fee").val())),a.find(".sc_sub_trial_days").length>0&&(b.subTrialDays=parseInt(a.find(".sc_sub_trial_days").val())),a.find(".sc_sub_currency").length>0&&(b.currency=a.find(".sc_sub_currency").val()),b.subDefaultSetupFee=b.subSetupFee,spApp.applyCoupon(a,b)},getSelectedPlan:function(a){var b=a.find(".sc_sub_wrapper").find(".sp-sub-plan");return b.is('input[type="radio"]')?b.filter(":checked"):b.find("option:selected")},setValuesFromSelectedPlan:function(a,b){var c=this.getSelectedPlan(a);c.length>0&&(void 0!==c.data("sub-amount")&&(b.subBaseRecurringAmount=parseInt(c.data("sub-amount")),b.baseAmount=b.subBaseRecurringAmount),void 0!==c.data("sub-id")&&(b.subPlanId=c.data("sub-id")),void 0!==c.data("sub-interval")&&(b.subInterval=c.data("sub-interval")),void 0!==c.data("sub-interval-count")&&(b.subIntervalCount=parseInt(c.data("sub-interval-count"))),void 0!==c.data("sub-setup-fee")&&(b.subSetupFee=parseInt(c.data("sub-setup-fee"))),0===b.subSetupFee&&(b.subSetupFee=b.subDefaultSetupFee),void 0!==c.data("sub-trial-days")&&(b.subTrialDays=parseInt(c.data("sub-trial-days"))),void 0!==c.data("sub-currency")&&(b.currency=c.data("sub-currency")),""===b.currency.trim()&&(b.currency=b.subDefaultCurrency),a.find(".sc_sub_amount").val(b.subBaseRecurringAmount),a.find(".sc_sub_id").val(b.subPlanId),a.find(".sc_sub_interval").val(b.subInterval),a.find(".sc_sub_interval_count").val(b.subIntervalCount),a.find(".sc_sub_setup_fee").val(b.subSetupFee),spApp.applyCoupon(a,b))},updateRecurringAmount:function(a,b){""===b.couponCode.trim()?b.subRecurringAmount=b.subBaseRecurringAmount*b.itemQuantity:b.subRecurringAmount=b.subDiscountedRecurringAmount;var c=a.find(".sc-recurring-total-amount");if(c.length>0){var d=spApp.unformatFromStripe(b.subRecurringAmount,b.currency);c.text(spApp.formatCurrency(d,b.currency)+this.getIntervalText(a,b))}b.baseAmount=b.subBaseRecurringAmount,b.addOnTotalAmountOperand=0,b.addOnTotalAmountOperand+=b.subSetupFee,b.subTrialDays>0&&(b.addOnTotalAmountOperand-=b.subRecurringAmount),spApp.updateTotalAmount(a,b)},getIntervalText:function(a,b){return 1===b.subIntervalCount?"/"+b.subInterval:b.subIntervalCount>1?" "+simplePaySubscriptionsFrontendGlobals.intervalEveryText+" "+b.subIntervalCount+" "+b.subInterval+"s":""}},b.on("spBaseInitComplete",function(a){spApp.Subscriptions.init()})}(jQuery);